<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title></title>
		<link rel="stylesheet" href="css/font-awesome.min.css">
		<link rel="stylesheet" href="css/cropper.min.css" />
		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" href="css/main.css">
		<link rel="stylesheet" href="css/userhead.css" />
	</head>
	<body>

		<header class="defaulthead">
			<i id="headback" class="fa fa-chevron-left"></i>
			<h1>修改头像</h1>
			<i id="headact" class="fa fa-folder-open"></i>
		</header>

		<div class="ctrbox" style="display: none;">
			<button class="cantuse" type="button" disabled id="scaleX_id"><i class="fa fa-exchange"></i>左右旋转</button>
			<button class="cantuse" type="button" disabled id="scaleY_id"><i class="fa fa-exchange fa-rotate-90"></i>上下旋转</button>
			<button class="cantuse" type="button" disabled id="rotateMax_id"><i class="fa fa-rotate-right"></i>旋转90°</button>
		</div>

		<div class="pickphoto" style="background-image:url('img/my-head-big.png')"></div>
		<div id="imgBox">
			<img id="userImage_id" width="300" height="300" />
		</div>
		<p class="pickphototext" style="text-align: center;"><i class="fa fa-picture-o"></i> 点击图片上传头像</p>
		<button class='defaultblock cantuse' type="button" disabled id="confirm_id" style="display: none;">请选择图片</button><br /><br />

		<input type="hidden" id="uploaddata" value="">

		<script src="js/jquery-3.3.1.min.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/cropper.min.js"></script>
		<script src="js/main.js"></script>
		<script>
			mui('body').on('tap', '#headback', function(e) {
				plus.webview.currentWebview().close('slide-out-right', 200);
			})

			// 扩展API加载完毕，现在可以正常调用扩展API
			function plusReady() {
				if (plus.storage.getItem("user_headimg") && plus.storage.getItem("user_headimg") != 'img/my-head.png') {
					$('.pickphoto').css('background-image', 'url(' + plus.storage.getItem("user_headimg") + ')');
				}
			}

			// 判断扩展API是否准备，否则监听'plusready'事件
			if (window.plus) {
				plusReady();
			} else {
				document.addEventListener('plusready', plusReady, false);
			}

			//选择文件
			mui('body').on('tap', '#headact,.pickphoto', function(e) {
				var bts = [{
					title: "拍照上传",
					style: "default"
				}, {
					title: "从相册选择",
					style: "default"
				}];
				plus.nativeUI.actionSheet({
						title: "选择相片",
						cancel: "取消",
						buttons: bts
					},
					function(e) {
						switch (e.index) {
							case 1:
								captureImage();
								break; //拍照
							case 2:
								selectImage();
								break; //相册选择
						}
					}
				);
			})

			mui('body').on('tap', '#scaleX_id', function(e) {
				window._scaleX = window._scaleX * -1;
				$("#userImage_id").cropper("scaleX", window._scaleX);
			})

			mui('body').on('tap', '#scaleY_id', function(e) {
				window._scaleY = window._scaleY * -1;
				$("#userImage_id").cropper("scaleY", window._scaleY);
			})

			mui('body').on('tap', '#rotateMax_id', function(e) {
				$("#userImage_id").cropper("rotate", 90);
			})

			//确定裁切
			mui('body').on('tap', '#confirm_id', function(e) {
				showcssWaiting();
				var dataURL = $("#userImage_id").cropper("getCroppedCanvas", {
					width: 300,
					height: 300
				});

				imgUrl = dataURL.toDataURL("image/png", 1);
				//$("#userImage_id").attr("src" , imgUrl);
				$("#userImage_id").cropper("replace", imgUrl);
				$("#userImage_id").cropper("clear"); //裁切完成取消显示裁切框
				$("#userImage_id").cropper("disable");
				//确定裁切后销毁裁切组件，标记一下，下次继续裁切时需要初始化一下裁切组件
				window.imageDisable = true;
				//禁用几个功能按钮
				$("button").prop("disabled", true).addClass('cantuse');
				$('#confirm_id').text('请选择图片');
				//向后台提供数据
				$('#uploaddata').attr("value", imgUrl);

				var bitmap = new plus.nativeObj.Bitmap("test");

				bitmap.loadBase64Data(imgUrl, function() {
					//console.log("加载Base64图片数据成功");
				}, function() {
					console.log('加载Base64图片数据失败：' + JSON.stringify(e));
				});

				var time = new Date();
				time = time.getTime();
				bitmap.save("_doc/a" + time + ".jpg", {}, function(i) {
					$('#uploaddata').attr("value", i.target);
					uploadFile();
				}, function(e) {
					mui.toast('保存图片失败：' + e.message);
				});

			});

			//初始化裁切组件
			initImageCropper();

			//拍照
			function captureImage() {
				var cmr = plus.camera.getCamera(2);
				cmr.captureImage(
					function(path) {
						//将图片地址转换
						plus.io.resolveLocalFileSystemURL(path, function(entry) {
							var newPath = entry.toLocalURL() + "?version=" + Math.random();
							loadImage(newPath);
							$('.pickphoto,.pickphototext').hide();
							$('.ctrbox,#confirm_id').show();
						});
					},
					function(error) {
						//			plus.nativeUI.toast('拍摄停止');
					}, {
						filename: "_documents/"
					}
				);

			}

			//文件上传
			function uploadFile() {

				var imgdata = $('#uploaddata').attr("value");

				if (imgdata != '') {
					showcssWaiting()

					var path = imgdata;

					var uploadUrl = localStorage.getItem('ajaxlinkhead') + "/user/upload/avatar";
					var task = plus.uploader.createUpload(uploadUrl, {
						method: "POST"
					}, function(t, status) {
						//上传完成
						if (status == 200) {
							//console.log(t.responseText);
							mui.toast("上传成功");
							var map = JSON.parse(t.responseText);
							var imgurl = map.big;

							var randomx = Math.floor(Math.random() * 10000000000);
							imgurl = localStorage.getItem('ajaxlinkhead') + imgurl + '?random=' + randomx;
							plus.storage.setItem("user_headimg", imgurl);
							var userdataview = plus.webview.getWebviewById('userdata.html');
							if (userdataview) {
								userdataview.evalJS("$('.dataheadimg').attr('src','" + imgurl + "');");
							}

							plus.webview.getLaunchWebview().evalJS("$('.headbox .headimg').attr('src','" + imgurl + "');");
							closecssWaiting();
							setTimeout(function() {
								plus.webview.getWebviewById('userhead.html').close('slide-out-right', 200)
							}, 100);

						} else {
							mui.toast("上传失败");
						}
						closecssWaiting();
					});

					task.addFile(path, {
						key: "UpFile"
					});
					task.start();

				} else {
					plus.nativeUI.toast('请选择图片');
				};

			}

			function initImageCropper() {
				//初始化组件
				$("#userImage_id").cropper({
					aspectRatio: 3 / 3,
					autoCropArea: 1,
					dragMode: "move", //设置移动图片、重新绘制选图区域
					cropBoxResizable: false,
					//movable: true,//是否允许移动裁切框
					zoomable: true, //是否允许放大图片
					guides: true, //取消显示裁切线中间的虚线网格
					minContainerWidth: 300,
					minContainerHeight: 300,
					minCanvasWidth: 300,
					minCanvasHeight: 300,
					crop: function(data) {
						//初始化
						window._scaleX = data.scaleX;
						window._scaleY = data.scaleY;
					}
				});
			}

			//选择图片
			function selectImage() {
				plus.gallery.pick(function(path) {
					loadImage(path);
					$('.pickphoto,.pickphototext').hide();
					$('.ctrbox,#confirm_id').show();
				}, function(e) {
					//		plus.nativeUI.toast("没有选择图片");
				});
			}

			//确定选择图片
			function loadImage(path) {
				var img = document.getElementById("userImage_id");
				img.src = path;
				if (window.imageDisable == true) {
					$("#userImage_id").cropper("enable");
				}
				$("#userImage_id").cropper("replace", path);
				//启用几个功能按钮
				$("button").prop("disabled", false).removeClass('cantuse');
				$('#confirm_id').text('保存上传');
				document.getElementById("userImage_id").onclick = function() {
					plus.runtime.openFile(path);
				}
			}
		</script>
	</body>
</html>
